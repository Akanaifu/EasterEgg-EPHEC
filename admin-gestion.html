<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Gestion Admin - Challenge IT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              neonBlue: "#38bdf8",
              neonPink: "#e879f9",
              cardBg: "#050816",
            },
          },
        },
      };
    </script>

    <style>
      body {
        background: radial-gradient(circle at top left, #0ea5e911, transparent 50%),
          radial-gradient(circle at bottom right, #a855f711, transparent 50%),
          #020617;
        color: #e5e7eb;
      }
      .grid-bg {
        background-image:
          linear-gradient(rgba(148, 163, 184, 0.08) 1px, transparent 1px),
          linear-gradient(90deg, rgba(148, 163, 184, 0.08) 1px, transparent 1px);
        background-size: 40px 40px;
      }
      .glass {
        background:
          radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%),
          radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.18), transparent 55%),
          linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
        backdrop-filter: blur(18px);
      }
    </style>
  </head>
  <body class="min-h-screen grid-bg flex flex-col">
    <main class="flex-1 flex items-center justify-center px-4 pb-12">
      <div class="relative glass rounded-3xl shadow-2xl px-8 py-10 max-w-4xl w-full">
        <!-- fl√®che retour + croix -->
        <div class="absolute top-4 right-4 flex items-center gap-2">
          <a
            href="admin.html"
            class="w-7 h-7 flex items-center justify-center rounded-full bg-slate-900/70 border border-slate-700 text-slate-300 text-sm hover:text-white hover:border-slate-500 transition"
            title="Retour au site principal"
          >
            ‚Üê
          </a>
          <a
            href="index.html"
            class="w-7 h-7 flex items-center justify-center rounded-full bg-slate-900/70 border border-slate-700 text-slate-300 text-sm hover:text-white hover:border-slate-500 transition"
            title="Fermer"
          >
            √ó
          </a>
        </div>

        <div class="mb-6 text-center">
          <h1
            class="text-2xl md:text-3xl font-bold mb-2 bg-gradient-to-r from-neonBlue to-neonPink bg-clip-text text-transparent"
          >
            Gestion des Easter Eggs
          </h1>
          <p class="text-xs text-slate-400">
            Ajoutez ici vos codes, leurs indices, le cours associ√© et votre nom.
          </p>
        </div>

        <!-- Layout 2 colonnes -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm">
          <!-- Colonne gauche : formulaire -->
          <div class="space-y-4">
            <h3 class="font-semibold text-slate-200 mb-1">Nouvel Easter Egg</h3>
            <form id="egg-form" class="space-y-4">
              <div>
                <label class="block mb-1">Code</label>
                <input
                  id="egg-code"
                  type="text"
                  required
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                />
              </div>
              <div>
                <label class="block mb-1">Cours / Bloc</label>
                <input
                  id="egg-cours"
                  type="text"
                  required
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                />
              </div>
              <div>
                <label class="block mb-1">Nom du professeur</label>
                <input
                  id="egg-teacher"
                  type="text"
                  required
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                />
              </div>
              <div>
                <label class="block mb-1">Indice (piste pour les √©tudiants)</label>
                <textarea
                  id="egg-indice"
                  rows="3"
                  required
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent resize-none"
                  placeholder="Ex : ¬´ Regardez pr√®s de la salle T302‚Ä¶ ¬ª"
                ></textarea>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1">Max utilisations</label>
                  <input
                    id="egg-max"
                    type="number"
                    min="1"
                    value="1"
                    required
                    class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block mb-1">Points</label>
                  <input
                    id="egg-points"
                    type="number"
                    min="0"
                    value="10"
                    required
                    class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                  />
                </div>
              </div>

              <button
                type="submit"
                class="w-full rounded-xl px-4 py-2.5 bg-gradient-to-r from-neonBlue to-neonPink text-xs font-semibold text-white shadow-lg hover:opacity-90 transition"
              >
                Ajouter l'Easter Egg
              </button>
            </form>

            <p id="egg-success" class="mt-3 text-xs text-green-400 hidden">
              Easter egg ajout√© avec succ√®s.
            </p>
            <p id="egg-error" class="mt-1 text-xs text-red-400 hidden">
              Erreur lors de l'ajout de l'easter egg.
            </p>
          </div>

          <!-- Colonne droite : rappel -->
          <div class="space-y-4">
            <h3 class="font-semibold text-slate-200 mb-1">Rappel</h3>
            <div class="rounded-2xl bg-slate-900/70 border border-slate-800 px-4 py-4">
              <p class="text-xs text-slate-300 mb-2">
                ‚Ä¢ <span class="font-semibold">Code</span> : ce que les √©tudiants doivent entrer.
              </p>
              <p class="text-xs text-slate-300 mb-2">
                ‚Ä¢ <span class="font-semibold">Cours / Bloc</span> : √† quel cours ou bloc est li√© l'Easter Egg.
              </p>
              <p class="text-xs text-slate-300 mb-2">
                ‚Ä¢ <span class="font-semibold">Nom du professeur</span> : affich√© dans la liste des indices.
              </p>
              <p class="text-xs text-slate-300 mb-2">
                ‚Ä¢ <span class="font-semibold">Indice</span> : petite piste pour guider les √©tudiants.
              </p>
              <p class="text-xs text-slate-300 mb-2">
                ‚Ä¢ <span class="font-semibold">Max utilisations</span> : nombre de fois o√π ce code peut √™tre valid√©.
              </p>
              <p class="text-xs text-slate-300 mb-2">
                ‚Ä¢ <span class="font-semibold">Points</span> : utilis√©s pour le classement.
              </p>
              <p class="text-xs text-slate-400 mt-4">
                Tous ces √©l√©ments sont stock√©s dans Firebase (collection <code>eggs</code>).
              </p>
            </div>
          </div>
          <!-- Liste des codes existants -->
          <div class="mt-8">
            <h3 class="font-semibold text-slate-200 mb-2">Codes existants</h3>
            <div id="egg-list" class="grid grid-cols-2 gap-3 text-xs w-full"></div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { db } from "./firebase-config.js";
      import {
        collection,
        addDoc,
        getDocs,
        query,
        where,
        deleteDoc,
        doc,
        onSnapshot
      } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    
      console.log('DB initialis√© ?', db);
    
      const eggForm = document.getElementById("egg-form");
      const eggSuccess = document.getElementById("egg-success");
      const eggError = document.getElementById("egg-error");
      const eggList = document.getElementById("egg-list");
      const eggsRef = collection(db, "eggs");
    
      /* ============================================================
         üî• 1. LISTE EN TEMPS R√âEL DES CODES EXISTANTS
      ============================================================ */
      onSnapshot(eggsRef, (snapshot) => {
        eggList.innerHTML = "";
    
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
    
          const row = document.createElement("div");
          row.className =
            "flex justify-between items-center bg-slate-900/60 border border-slate-800 px-3 py-2 rounded-lg";
    
          row.innerHTML = `
            <div>
              <p><span class="font-semibold text-neonBlue">Code :</span> ${data.code}</p>
              <p>Cours : ${data.cours}</p>
              <p>Prof : ${data.teacherName}</p>
            </div>
    
            <button 
              class="text-red-400 text-xl px-3 hover:text-red-300"
              data-id="${docSnap.id}"
            >
              √ó
            </button>
          `;
    
          // üî• Bouton suppression
          row.querySelector("button").addEventListener("click", async () => {
            await deleteDoc(doc(db, "eggs", docSnap.id));
          });
    
          eggList.appendChild(row);
        });
      });
    
      /* ============================================================
         üî• 2. AJOUT AVEC V√âRIFICATION D‚ÄôUN CODE UNIQUE
      ============================================================ */
      eggForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        eggSuccess.classList.add("hidden");
        eggError.classList.add("hidden");
    
        const code = document.getElementById("egg-code").value.trim();
        const cours = document.getElementById("egg-cours").value.trim();
        const teacherName = document.getElementById("egg-teacher").value.trim();
        const indice = document.getElementById("egg-indice").value.trim();
        const maxUses = parseInt(document.getElementById("egg-max").value, 10) || 1;
        const points = parseInt(document.getElementById("egg-points").value, 10) || 0;
    
        if (!code || !cours || !teacherName || !indice) {
          eggError.textContent = "Veuillez remplir tous les champs.";
          eggError.classList.remove("hidden");
          return;
        }
    
        try {
          // üîç V√©rification si le code existe d√©j√†
          const q = query(eggsRef, where("code", "==", code));
          const existing = await getDocs(q);
    
          if (!existing.empty) {
            eggError.textContent = "‚ùå Ce code existe d√©j√† dans la base.";
            eggError.classList.remove("hidden");
            return;
          }
    
          // ‚ûï Ajout dans Firestore
          await addDoc(eggsRef, {
            code,
            cours,
            teacherName,
            indice,
            maxUses,
            usedCount: 0,
            points,
          });
    
          eggForm.reset();
          eggSuccess.classList.remove("hidden");
    
        } catch (err) {
          console.error('Erreur compl√®te:', err);
          eggError.textContent = "Erreur lors de l'ajout de l'easter egg.";
          eggError.classList.remove("hidden");
        }
      });
    </script>
  </body>
</html>






